@using System.Collections;
@model EcoLoop.Models.StoreEditViewModel
@{
    ViewData["Title"] = "Редакция на магазин";
    var categories = ViewData["Categories"] as string[] ?? new string[0];
    var allStores = ViewData["AllStores"] as IEnumerable ?? new object[0];
}

<h1>Редакция на магазин</h1>

<form asp-action="Edit" method="post" enctype="multipart/form-data">
    @Html.AntiForgeryToken()
    <input type="hidden"
           name="Id"
           value="@(Model?.Id ?? 0)" />

    <div>
        <label>Избери магазин за редакция</label>
        <select id="storeSelector" class="form-control" onchange="onStoreSelect(this)">
            <option value="">-- избери магазин --</option>
            @foreach (var sObj in allStores)
            {
                // sObj is anonymous type { Id, Name } from controller; use reflection to avoid dynamic
                var sidProp = sObj.GetType().GetProperty("Id");
                var nameProp = sObj.GetType().GetProperty("Name");
                var sid = sidProp != null ? (int)sidProp.GetValue(sObj) : 0;
                var sname = nameProp != null ? nameProp.GetValue(sObj)?.ToString() : "";
                var isSelected = Model?.Id == sid;
                <option value="@sid" selected="@(isSelected ? "selected" : null)">@sname</option>
            }
        </select>
    </div>

    <div asp-validation-summary="ModelOnly" class="text-danger"></div>

    <div>
        <label asp-for="Name"></label>
        <input asp-for="Name" class="form-control" />
        <span asp-validation-for="Name" class="text-danger"></span>
    </div>

    <div>
        <label asp-for="Category"></label>
        <select asp-for="Category" class="form-control">
            <option value="">-- избери --</option>
            @foreach (var c in categories)
            {
                var isSelected = string.Equals(Model?.Category, c, System.StringComparison.Ordinal);
                <option value="@c" selected="@(isSelected ? "selected" : null)">@c</option>
            }
        </select>
    </div>

    <div>
        <label asp-for="ShortDescription"></label>
        <input asp-for="ShortDescription" maxlength="200" class="form-control" />
        <span asp-validation-for="ShortDescription" class="text-danger"></span>
    </div>

    <div>
        <label asp-for="Description"></label>
        <textarea asp-for="Description" class="form-control"></textarea>
    </div>

    <div>
        <label asp-for="Address"></label>
        <input asp-for="Address" class="form-control" />
    </div>

    <div>
        <label asp-for="Latitude"></label>
        <input asp-for="Latitude" type="number" step="0.000001" class="form-control" />
        <label asp-for="Longitude"></label>
        <input asp-for="Longitude" type="number" step="0.000001" class="form-control" />
    </div>

    <div>
        <label>Работно време</label>
        <div>
            <label>Пон-Пет</label>
            <input name="MonToFriHours" value="@(Model?.MonToFriHours ?? "")" class="form-control" placeholder="напр. 09:00-18:00" />
        </div>
        <div>
            <label>Събота</label>
            <input name="SatHours" value="@(Model?.SatHours ?? "")" class="form-control" placeholder="напр. 10:00-14:00" />
        </div>
        <div>
            <label>Неделя</label>
            <input name="SunHours" value="@(Model?.SunHours ?? "")" class="form-control" placeholder="напр. затворено или 11:00-15:00" />
        </div>
    </div>

    <div>
        <label>Съществуващи снимки</label>
        <div class="existing-images" id="existingImages">
            @if (Model?.ExistingImages != null && Model.ExistingImages.Any())
            {
                foreach (var img in Model.ExistingImages)
                {
                    <div class="existing-image" data-id="@img.Id" style="display:inline-block;margin-right:8px;position:relative;">
                        <img src="@img.Url" alt="img" style="height:72px;border-radius:6px;border:1px solid #e6efe7" />
                        <button type="button" class="btn small remove-image" data-id="@img.Id" style="position:absolute;top:-6px;right:-6px;">✕</button>
                    </div>
                }
            }
            else
            {
                <div class="small-muted">Няма качени снимки</div>
            }
        </div>
    </div>

    <div>
        <label asp-for="Photos">Добави снимки</label>
        <input asp-for="Photos" type="file" multiple accept="image/*" class="form-control" />
        <small class="form-text text-muted">Можете да качите допълнителни снимки (jpg, png, webp).</small>
    </div>

    <div id="phones">
        <label>Телефони</label>
        <div id="phoneRows">
            @if (Model?.Phones != null && Model.Phones.Any())
            {
                foreach (var ph in Model.Phones)
                {
                    <div class="phone-row" style="margin-bottom:8px;">
                        <input name="Phones" value="@ph" class="form-control" />
                        <button type="button" class="btn small remove-phone">Премахни</button>
                    </div>
                }
            }
            else
            {
                <div class="phone-row" style="margin-bottom:8px;">
                    <input name="Phones" class="form-control" />
                    <button type="button" class="btn small remove-phone">Премахни</button>
                </div>
            }
        </div>

        <div style="margin-top:8px;">
            <button type="button" id="addPhone" class="btn">Добави още телефон</button>
        </div>
    </div>

    <div>
        <label asp-for="Website"></label>
        <input asp-for="Website" class="form-control" />
    </div>

    <div>
        <label>
            <input asp-for="AcceptsOwnPackaging" /> Приема собствени опаковки
        </label>
    </div>

    <div>
        <label>
            <input asp-for="IsProducer" /> Производител
        </label>
    </div>

    <div style="margin-top:12px;">
        <button type="submit" class="btn btn-primary">Запази</button>
        <a asp-action="Index" asp-controller="Home" class="btn btn-link">Отказ</a>
    </div>
</form>

@section Scripts {
    <script>
        function onStoreSelect(sel) {
            var id = sel.value;
            if (!id) {
                window.location.href = '@Url.Action("Edit", "Store")';
            } else {
                window.location.href = '@Url.Action("Edit", "Store")' + '/' + id;
            }
        }

        (function () {
            var addBtn = document.getElementById('addPhone');
            var phoneRows = document.getElementById('phoneRows');

            function createPhoneRow(value) {
                var div = document.createElement('div');
                div.className = 'phone-row';
                div.style.marginBottom = '8px';
                var input = document.createElement('input');
                input.name = 'Phones';
                input.className = 'form-control';
                input.placeholder = '+359 ...';
                if (value) input.value = value;
                var remove = document.createElement('button');
                remove.type = 'button';
                remove.className = 'btn small remove-phone';
                remove.textContent = 'Премахни';
                remove.addEventListener('click', function () { div.remove(); });
                div.appendChild(input);
                div.appendChild(remove);
                return div;
            }

            addBtn?.addEventListener('click', function () { phoneRows.appendChild(createPhoneRow()); });

            document.querySelectorAll('.remove-phone').forEach(function (b) {
                b.addEventListener('click', function (ev) { ev.preventDefault(); b.parentElement?.remove(); });
            });

            // delete image AJAX with antiforgery token
            document.querySelectorAll('.remove-image').forEach(function (btn) {
                btn.addEventListener('click', function (ev) {
                    ev.preventDefault();
                    var id = btn.getAttribute('data-id');
                    if (!id) return;
                    if (!confirm('Наистина ли искате да изтриете тази снимка?')) return;
                    var token = document.querySelector('input[name="__RequestVerificationToken"]')?.value;
                    fetch('@Url.Action("DeleteImage","Store")', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: new URLSearchParams({ imageId: id, __RequestVerificationToken: token })
                    }).then(r => r.json()).then(j => {
                        if (j?.ok) { btn.closest('.existing-image')?.remove(); }
                        else alert('Грешка при изтриване на снимката');
                    }).catch(() => alert('Грешка при изтриване на снимката'));
                });
            });
        })();
    </script>
}