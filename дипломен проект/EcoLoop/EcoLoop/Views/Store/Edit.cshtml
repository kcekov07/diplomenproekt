@model EcoLoop.Models.StoreEditViewModel
@{
    ViewData["Title"] = "Редакция на магазин";
    var categories = ViewData["Categories"] as string[] ?? new string[0];
}

<h1>Редакция на магазин</h1>

<form asp-action="Edit" method="post" enctype="multipart/form-data">
    @Html.AntiForgeryToken()
    <input type="hidden" asp-for="Id" />

    <div asp-validation-summary="ModelOnly" class="text-danger"></div>

    <div>
        <label asp-for="Name"></label>
        <input asp-for="Name" class="form-control" />
        <span asp-validation-for="Name" class="text-danger"></span>
    </div>

    <div>
        <label asp-for="Category"></label>
        <select asp-for="Category" class="form-control">
            <option value="">-- избери --</option>
            @foreach (var c in categories)
            {
                var selected = string.Equals(Model?.Category, c, StringComparison.Ordinal) ? "selected" : "";
                <option value="@c" selected="@selected">@c</option>
            }
        </select>
    </div>

    <div>
        <label asp-for="ShortDescription"></label>
        <input asp-for="ShortDescription" maxlength="200" class="form-control" />
        <span asp-validation-for="ShortDescription" class="text-danger"></span>
    </div>

    <div>
        <label asp-for="Description"></label>
        <textarea asp-for="Description" class="form-control"></textarea>
    </div>

    <div>
        <label asp-for="Address"></label>
        <input asp-for="Address" class="form-control" />
    </div>

    <div>
        <label asp-for="Latitude"></label>
        <input asp-for="Latitude" type="number" step="0.000001" class="form-control" />
        <label asp-for="Longitude"></label>
        <input asp-for="Longitude" type="number" step="0.000001" class="form-control" />
    </div>

    <div>
        <label>Работно време</label>
        <div>
            <label>Пон-Пет</label>
            <input name="MonToFriHours" value="@(Model?.MonToFriHours ?? "")" class="form-control" placeholder="напр. 09:00-18:00" />
        </div>
        <div>
            <label>Събота</label>
            <input name="SatHours" value="@(Model?.SatHours ?? "")" class="form-control" placeholder="напр. 10:00-14:00" />
        </div>
        <div>
            <label>Неделя</label>
            <input name="SunHours" value="@(Model?.SunHours ?? "")" class="form-control" placeholder="напр. затворено или 11:00-15:00" />
        </div>
    </div>

    <div>
        <label>Съществуващи снимки</label>
        <div class="existing-images">
            @if (Model?.ExistingImages != null && Model.ExistingImages.Any())
            {
                foreach (var img in Model.ExistingImages)
                {
                    <img src="@img.Url" alt="img" style="height:72px;margin-right:8px;border-radius:6px;border:1px solid #e6efe7" />
                }
            }
            else
            {
                <div class="small-muted">Няма качени снимки</div>
            }
        </div>
    </div>

    <div>
        <label asp-for="Photos">Добави снимки</label>
        <input asp-for="Photos" type="file" multiple accept="image/*" class="form-control" />
        <small class="form-text text-muted">Можете да качите допълнителни снимки (jpg, png, webp).</small>
    </div>

    <div id="phones">
        <label>Телефони</label>
        <div id="phoneRows">
            @if (Model?.Phones != null && Model.Phones.Any())
            {
                foreach (var ph in Model.Phones)
                {
                    <div class="phone-row">
                        <input name="Phones" value="@ph" class="form-control" />
                        <button type="button" class="btn small remove-phone">Премахни</button>
                    </div>
                }
            }
            else
            {
                <div class="phone-row">
                    <input name="Phones" class="form-control" />
                    <button type="button" class="btn small remove-phone">Премахни</button>
                </div>
            }
        </div>

        <div style="margin-top:8px;">
            <button type="button" id="addPhone" class="btn">Добави още телефон</button>
        </div>
    </div>

    <div>
        <label for="Website">Уебсайт</label>
        <input asp-for="Website" class="form-control" id="Website" />
    </div>

    <div>
        <label>
            <input asp-for="AcceptsOwnPackaging" /> Приема собствени опаковки
        </label>
    </div>

    <div>
        <label>
            <input asp-for="IsProducer" /> Производител
        </label>
    </div>

    <button type="submit" class="btn btn-primary">Запази</button>
</form>

@section Scripts {
    <script>
        (function () {
            var addBtn = document.getElementById('addPhone');
            var phoneRows = document.getElementById('phoneRows');

            function createPhoneRow(value) {
                var div = document.createElement('div');
                div.className = 'phone-row';
                var input = document.createElement('input');
                input.name = 'Phones';
                input.className = 'form-control';
                input.placeholder = '+359 ...';
                if (value) input.value = value;
                var remove = document.createElement('button');
                remove.type = 'button';
                remove.className = 'btn small remove-phone';
                remove.textContent = 'Премахни';
                remove.addEventListener('click', function () { div.remove(); });
                div.appendChild(input);
                div.appendChild(remove);
                return div;
            }

            addBtn?.addEventListener('click', function () {
                var row = createPhoneRow();
                // insert before add button container so it stays above the button
                phoneRows.appendChild(row);
            });

            // attach remove handlers to existing remove buttons
            document.querySelectorAll('.remove-phone').forEach(function (b) {
                b.addEventListener('click', function (ev) {
                    ev.preventDefault();
                    var parent = b.parentElement;
                    if (parent) parent.remove();
                });
            });
        })();
    </script>
}