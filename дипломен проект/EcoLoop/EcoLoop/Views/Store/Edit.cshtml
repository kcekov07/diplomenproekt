@model EcoLoop.Models.StoreEditViewModel
@{
    ViewData["Title"] = "Редакция на магазин";
    var categories = ViewData["Categories"] as string[] ?? Array.Empty<string>();
}

@section Styles {
    <link rel="stylesheet" href="~/css/store-form.css" asp-append-version="true" />
}

<div class="sf-page">
    <div class="sf-wrap">
        <div class="sf-head">
            <div>
                <h1 class="sf-title">Редакция на магазин</h1>
                <p class="sf-subtitle">Обнови информацията, таговете и снимките. Новите снимки ще се добавят към галерията.</p>
            </div>
        </div>

        <form asp-action="Edit" method="post" enctype="multipart/form-data" class="sf-form">
            @Html.AntiForgeryToken()
            <input type="hidden" asp-for="Id" />
            <div asp-validation-summary="ModelOnly" class="sf-validation"></div>

            <!-- SECTION: Избор на магазин (ако ползваш dropdown) -->
            @* Ако твоят Edit view позволява избор на магазин от dropdown, остави това:
               Ако не ти трябва - махни секцията. *@
            @if (ViewData["AllStores"] != null)
            {
                var allStores = ViewData["AllStores"] as IEnumerable<dynamic>;
                if (allStores != null)
                {
                    <section class="sf-card">
                        <div class="sf-card__head">
                            <h2>Избор на магазин</h2>
                            <span class="sf-hint">По избор</span>
                        </div>

                        <div class="sf-grid sf-grid--2">
                            <div class="sf-field sf-span-2">
                                <label>Избери магазин</label>
                                <select id="storePicker" class="sf-select">
                                    <option value="">-- избери --</option>
                                    @foreach (var s in allStores)
                                    {
                                        <option value="@s.Id" selected="@(Model.Id == (int)s.Id ? "selected" : null)">@s.Name</option>
                                    }
                                </select>
                                <div class="sf-help">Ако смениш избора, ще те пренасочи към Edit на избрания магазин.</div>
                            </div>
                        </div>
                    </section>

                    <script>
                        (function () {
                            const picker = document.getElementById('storePicker');
                            if (!picker) return;
                            picker.addEventListener('change', () => {
                                const id = picker.value;
                                if (!id) return;
                                window.location.href = '@Url.Action("Edit", "Store")' + '?id=' + encodeURIComponent(id);
                            });
                        })();
                    </script>
                }
            }

            <!-- SECTION: Основна информация -->
            <section class="sf-card">
                <div class="sf-card__head">
                    <h2>Основна информация</h2>
                    <span class="sf-hint">Поддържай краткото описание ясно</span>
                </div>

                <div class="sf-grid sf-grid--2">
                    <div class="sf-field">
                        <label asp-for="Name">Име</label>
                        <input asp-for="Name" />
                        <span asp-validation-for="Name" class="sf-error"></span>
                    </div>

                    <div class="sf-field">
                        <label asp-for="Category">Категория</label>
                        <select asp-for="Category">
                            <option value="">-- избери --</option>
                            @foreach (var c in categories)
                            {
                                <option value="@c">@c</option>
                            }
                        </select>
                        <span asp-validation-for="Category" class="sf-error"></span>
                    </div>

                    <div class="sf-field sf-span-2">
                        <label asp-for="ShortDescription">Кратко описание</label>
                        <input asp-for="ShortDescription" maxlength="200" />
                        <span asp-validation-for="ShortDescription" class="sf-error"></span>
                    </div>

                    <div class="sf-field sf-span-2">
                        <label asp-for="Description">Описание</label>
                        <textarea asp-for="Description"></textarea>
                        <span asp-validation-for="Description" class="sf-error"></span>
                    </div>
                </div>
            </section>

            <!-- SECTION: Локация -->
            <section class="sf-card">
                <div class="sf-card__head">
                    <h2>Локация</h2>
                    <span class="sf-hint">За картата и търсенето</span>
                </div>

                <div class="sf-grid sf-grid--2">
                    <div class="sf-field sf-span-2">
                        <label asp-for="Address">Адрес</label>
                        <input asp-for="Address" />
                        <span asp-validation-for="Address" class="sf-error"></span>
                    </div>

                    <div class="sf-field">
                        <label asp-for="Latitude">Latitude</label>
                        <input asp-for="Latitude" type="number" step="0.000001" />
                    </div>

                    <div class="sf-field">
                        <label asp-for="Longitude">Longitude</label>
                        <input asp-for="Longitude" type="number" step="0.000001" />
                    </div>
                </div>
            </section>

            <!-- SECTION: Работно време -->
            <section class="sf-card">
                <div class="sf-card__head">
                    <h2>Работно време</h2>
                    <span class="sf-hint">По избор</span>
                </div>

                <div class="sf-grid sf-grid--3">
                    <div class="sf-field">
                        <label asp-for="MonToFriHours">Пон–Пет</label>
                        <input asp-for="MonToFriHours" placeholder="09:00-18:00" />
                    </div>
                    <div class="sf-field">
                        <label asp-for="SatHours">Събота</label>
                        <input asp-for="SatHours" placeholder="10:00-14:00" />
                    </div>
                    <div class="sf-field">
                        <label asp-for="SunHours">Неделя</label>
                        <input asp-for="SunHours" placeholder="затворено" />
                    </div>
                </div>
            </section>

            <!-- SECTION: Еко & услуги -->
            <section class="sf-card">
                <div class="sf-card__head">
                    <h2>Еко & услуги</h2>
                    <span class="sf-hint">Показва се като badges</span>
                </div>

                <div class="sf-grid sf-grid--2">
                    <div class="sf-field sf-span-2">
                        <label asp-for="EcoTags">Еко тагове</label>
                        <input asp-for="EcoTags" placeholder="Zero-waste, Bio, Local, Vegan" />
                    </div>

                    <div class="sf-field sf-span-2">
                        <label asp-for="Certifications">Сертификати</label>
                        <input asp-for="Certifications" placeholder="FSC, EU Organic" />
                    </div>
                </div>

                <div class="sf-toggles">
                    <label class="sf-toggle">
                        <input asp-for="AcceptsOwnPackaging" />
                        <span class="sf-toggle__ui"></span>
                        <span class="sf-toggle__text">Приема собствени опаковки</span>
                    </label>

                    <label class="sf-toggle">
                        <input asp-for="IsProducer" />
                        <span class="sf-toggle__ui"></span>
                        <span class="sf-toggle__text">Производител</span>
                    </label>

                    <label class="sf-toggle">
                        <input asp-for="HasRefillStation" />
                        <span class="sf-toggle__ui"></span>
                        <span class="sf-toggle__text">Refill / наливни</span>
                    </label>

                    <label class="sf-toggle">
                        <input asp-for="HasDelivery" />
                        <span class="sf-toggle__ui"></span>
                        <span class="sf-toggle__text">Доставка</span>
                    </label>
                </div>
            </section>

            <!-- SECTION: Контакти -->
            <section class="sf-card">
                <div class="sf-card__head">
                    <h2>Контакти</h2>
                    <span class="sf-hint">По избор</span>
                </div>

                <div class="sf-grid sf-grid--2">
                    <div class="sf-field">
                        <label asp-for="Website">Уебсайт</label>
                        <input asp-for="Website" placeholder="https://..." />
                    </div>

                    <div class="sf-field">
                        <label asp-for="Email">Имейл</label>
                        <input asp-for="Email" type="email" placeholder="store@email.com" />
                    </div>

                    <div class="sf-field">
                        <label asp-for="InstagramUrl">Instagram</label>
                        <input asp-for="InstagramUrl" placeholder="https://instagram.com/..." />
                    </div>

                    <div class="sf-field">
                        <label asp-for="FacebookUrl">Facebook</label>
                        <input asp-for="FacebookUrl" placeholder="https://facebook.com/..." />
                    </div>
                </div>

                <div class="sf-field sf-mt">
                    <label>Телефони</label>
                    <div id="phonesList" class="sf-repeater">
                        @if (Model.Phones != null && Model.Phones.Any(p => !string.IsNullOrWhiteSpace(p)))
                        {
                            foreach (var ph in Model.Phones)
                            {
                                <div class="sf-repeater__row">
                                    <input name="Phones" value="@ph" placeholder="+359 88 123 4567" />
                                    <button type="button" class="sf-iconbtn sf-remove" title="Премахни">✕</button>
                                </div>
                            }
                        }
                        else
                        {
                            <div class="sf-repeater__row">
                                <input name="Phones" placeholder="+359 88 123 4567" />
                                <button type="button" class="sf-iconbtn sf-remove" title="Премахни" style="display:none;">✕</button>
                            </div>
                        }
                    </div>
                    <button type="button" id="addPhoneBtn" class="sf-secondary">+ Добави още телефон</button>
                </div>
            </section>

            <!-- SECTION: Съществуващи снимки -->
            <section class="sf-card">
                <div class="sf-card__head">
                    <h2>Текущи снимки</h2>
                    <span class="sf-hint">Можеш да изтриеш снимка</span>
                </div>

                @if (Model.ExistingImages != null && Model.ExistingImages.Any())
                {
                    <div class="sf-existing">
                        @foreach (var img in Model.ExistingImages)
                        {
                            <div class="sf-existing__item" data-imgid="@img.Id">
                                <div class="sf-existing__thumb" style="background-image:url('@img.Url')"></div>
                                <button type="button" class="sf-existing__delete"
                                        data-imgid="@img.Id">
                                    Изтрий
                                </button>
                            </div>
                        }
                    </div>

                    <div class="sf-help">Изтриването става веднага (AJAX) и премахва файла от диска.</div>
                }
                else
                {
                    <div class="sf-empty">Няма качени снимки.</div>
                }
            </section>

            <!-- SECTION: Добавяне на нови снимки -->
            <section class="sf-card">
                <div class="sf-card__head">
                    <h2>Добави нови снимки</h2>
                    <span class="sf-hint">Preview преди запазване</span>
                </div>

                <div class="sf-upload">
                    <input id="photosInput" name="Photos" type="file" multiple accept="image/*" />
                    <div class="sf-upload__note">Избраните снимки ще се добавят към съществуващите.</div>
                </div>

                <div id="photoPreviews" class="sf-previews"></div>
            </section>

            <div class="sf-actions">
                <button type="submit" class="sf-primary">Запази промените</button>
                <button type="button" class="sf-link" onclick="history.back()">
                    ← Назад
                </button>

            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script>
        (function () {
            // Anti-forgery token for AJAX
            const tokenInput = document.querySelector('input[name="__RequestVerificationToken"]');
            const token = tokenInput ? tokenInput.value : "";

            // Phones repeater
            const phonesList = document.getElementById('phonesList');
            const addPhoneBtn = document.getElementById('addPhoneBtn');

            function refreshRemoveButtons() {
                const rows = phonesList.querySelectorAll('.sf-repeater__row');
                rows.forEach(row => {
                    const btn = row.querySelector('.sf-remove');
                    if (!btn) return;
                    btn.style.display = rows.length > 1 ? 'inline-flex' : 'none';
                });
            }

            phonesList?.addEventListener('click', (e) => {
                const btn = e.target.closest('.sf-remove');
                if (!btn) return;
                const row = btn.closest('.sf-repeater__row');
                if (!row) return;
                if (phonesList.querySelectorAll('.sf-repeater__row').length <= 1) return;
                row.remove();
                refreshRemoveButtons();
            });

            addPhoneBtn?.addEventListener('click', () => {
                const row = document.createElement('div');
                row.className = 'sf-repeater__row';
                row.innerHTML = `
                    <input name="Phones" placeholder="+359 88 123 4567" />
                    <button type="button" class="sf-iconbtn sf-remove" title="Премахни">✕</button>
                `;
                phonesList.appendChild(row);
                refreshRemoveButtons();
            });

            refreshRemoveButtons();

            // Delete existing image (AJAX -> /Store/DeleteImage)
            document.querySelectorAll('.sf-existing__delete').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const imgId = btn.getAttribute('data-imgid');
                    if (!imgId) return;

                    btn.disabled = true;
                    btn.textContent = "Изтривам...";

                    try {
                        const resp = await fetch('@Url.Action("DeleteImage", "Store")', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8'
                            },
                            body: `__RequestVerificationToken=${encodeURIComponent(token)}&imageId=${encodeURIComponent(imgId)}`
                        });

                        const data = await resp.json();
                        if (data && data.ok) {
                            const card = document.querySelector(`.sf-existing__item[data-imgid="${imgId}"]`);
                            card?.remove();
                        } else {
                            btn.disabled = false;
                            btn.textContent = "Изтрий";
                            alert("Неуспешно изтриване. Опитай пак.");
                        }
                    } catch (e) {
                        btn.disabled = false;
                        btn.textContent = "Изтрий";
                        alert("Грешка при изтриване. Опитай пак.");
                    }
                });
            });

            // New photos preview + remove before submit (DataTransfer)
            const fileInput = document.getElementById('photosInput');
            const previews = document.getElementById('photoPreviews');
            let dt = new DataTransfer();

            function renderPreviews() {
                previews.innerHTML = '';
                const files = Array.from(dt.files);

                if (files.length === 0) {
                    previews.innerHTML = `<div class="sf-empty">Няма избрани нови снимки.</div>`;
                    return;
                }

                files.forEach((file, index) => {
                    const url = URL.createObjectURL(file);

                    const card = document.createElement('div');
                    card.className = 'sf-preview';

                    const img = document.createElement('img');
                    img.src = url;
                    img.alt = file.name;

                    const meta = document.createElement('div');
                    meta.className = 'sf-preview__meta';
                    meta.innerHTML = `
                        <div class="sf-preview__name" title="${file.name}">${file.name}</div>
                        <div class="sf-preview__sub">${Math.round(file.size / 1024)} KB${index === 0 ? " • първа от новите" : ""}</div>
                    `;

                    const remove = document.createElement('button');
                    remove.type = 'button';
                    remove.className = 'sf-preview__remove';
                    remove.textContent = 'Премахни';
                    remove.addEventListener('click', () => {
                        const newDt = new DataTransfer();
                        files.forEach((f, i) => { if (i !== index) newDt.items.add(f); });
                        dt = newDt;
                        fileInput.files = dt.files;
                        renderPreviews();
                    });

                    card.appendChild(img);
                    card.appendChild(meta);
                    card.appendChild(remove);
                    previews.appendChild(card);
                });
            }

            fileInput?.addEventListener('change', () => {
                const incoming = Array.from(fileInput.files || []);
                incoming.forEach(f => dt.items.add(f));
                fileInput.files = dt.files;
                renderPreviews();
            });

            renderPreviews();
        })();
    </script>
}
