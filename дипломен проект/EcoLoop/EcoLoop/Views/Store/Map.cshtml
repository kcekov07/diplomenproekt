@{
    ViewData["Title"] = "Карта на еко магазините";
}

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
<link rel="stylesheet" href="@Url.Content("~/css/map.css")" />

<div class="container">
    <h2 style="margin:16px 0; color:var(--eco-green-dark);">
        <span style="margin-right:8px;">🗺️</span> Карта на еко магазините
    </h2>

    <div class="map-wrapper">
        <aside class="map-sidebar" aria-label="Map filters">
            <div class="sidebar-header-row">
                <div class="sidebar-title"><span>🔎</span> Филтри</div>
                <button class="theme-toggle-btn" id="toggleIcons" title="Toggle icons">⚙️</button>
            </div>

            <div class="accordion-section">
                <button class="accordion-btn" data-target="catContent">Категория</button>
                <div id="catContent" class="accordion-content">
                    <select id="categorySelect" class="form-select">
                        <option value="*">Всички</option>
                        <option value="Еко храни">🥕 Био храни</option>
                        <option value="Натурална козметика">🧴 Натурална козметика</option>
                        <option value="Еко облекло">👕 Еко облекло</option>
                        <option value="Напитки">🍵 Напитки</option>
                        <option value="Продукти за дома">🧼 Продукти за дома</option>
                    </select>
                </div>
            </div>

            <div class="accordion-section">
                <button class="accordion-btn" data-target="distContent">Разстояние</button>
                <div id="distContent" class="accordion-content">
                    <select id="distanceSelect" class="form-select">
                        <option value="9999">Без лимит</option>
                        <option value="5">До 5 km</option>
                        <option value="10">До 10 km</option>
                        <option value="25" selected>До 25 km</option>
                        <option value="50">До 50 km</option>
                    </select>
                    <div class="small-muted" style="margin-top:8px;">Работи спрямо текущото ви местоположение.</div>
                </div>
            </div>

            <div class="accordion-section">
                <button class="accordion-btn" data-target="otherContent">Още филтри</button>
                <div id="otherContent" class="accordion-content">
                    <div style="display:flex;flex-direction:column;gap:8px;">
                        <label><input id="filterOwn" type="checkbox" /> Приема собствени опаковки</label>
                        <label><input id="filterOpen" type="checkbox" /> Работи сега</label>
                        <label>
                            Рейтинг
                            <select id="filterRating" class="form-select" style="margin-top:6px;">
                                <option value="0">Всички</option>
                                <option value="3">≥ 3</option>
                                <option value="4">≥ 4</option>
                                <option value="4.5">≥ 4.5</option>
                            </select>
                        </label>
                    </div>
                </div>
            </div>

            <div style="margin-top:12px;">
                <button id="btnApply" class="sidebar-full-btn popup-btn-green">🟢 Магазини около мен</button>
                <button id="btnReset" class="sidebar-full-btn popup-btn-outline" style="margin-top:8px;">🔁 Нулирай филтрите</button>
            </div>

            <hr style="margin:12px 0;" />

            <div>
                <div class="sidebar-title" style="font-size:15px;margin-bottom:8px;">Резултати</div>
                <div class="sidebar-results" id="resultsList">Зареждане…</div>
            </div>
        </aside>

        <div id="map"></div>
    </div>

    <!-- BELOW THE MAP: ALL STORES LIST (populated by map.js on load) -->
    <section style="margin-top:22px;">
        <h3 style="margin-bottom:12px;">Всички магазини</h3>
        <div id="storesList" class="sidebar-results" style="padding:12px;">
            Зареждане…
        </div>
    </section>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<script src="@Url.Content("~/js/map.js")"></script>

<script>
    // accordion helper + expose controls to map.js
    document.addEventListener('DOMContentLoaded', function () {
        document.querySelectorAll('.accordion-btn').forEach(function (b) {
            b.addEventListener('click', function () {
                var id = b.getAttribute('data-target');
                var el = document.getElementById(id);
                if (!el) return;
                el.style.display = (el.style.display === 'block') ? 'none' : 'block';
            });
        });

        window.mapFilters = {
            categoryEl: document.getElementById('categorySelect'),
            distanceEl: document.getElementById('distanceSelect'),
            ownEl: document.getElementById('filterOwn'),
            openEl: document.getElementById('filterOpen'),
            ratingEl: document.getElementById('filterRating'),
            resultsEl: document.getElementById('resultsList'),
            storesListEl: document.getElementById('storesList') // new
        };
    });
</script>