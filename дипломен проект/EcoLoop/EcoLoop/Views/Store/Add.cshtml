@model EcoLoop.Models.StoreAddViewModel
@{
    ViewData["Title"] = "Добавяне на магазин";
    var categories = ViewData["Categories"] as string[] ?? Array.Empty<string>();
}

@section Styles {
    <link rel="stylesheet" href="~/css/store-form.css" asp-append-version="true" />
}

<div class="sf-page">
    <div class="sf-wrap">
        <div class="sf-head">
            <div>
                <h1 class="sf-title">Добавяне на магазин</h1>
                <p class="sf-subtitle">Попълни основната информация и добави снимки, за да изглежда магазинът ти отлично.</p>
            </div>
        </div>

        <form asp-action="Add" method="post" enctype="multipart/form-data" class="sf-form">
            @Html.AntiForgeryToken()
            <div asp-validation-summary="ModelOnly" class="sf-validation"></div>

            <!-- SECTION: Основна информация -->
            <section class="sf-card">
                <div class="sf-card__head">
                    <h2>Основна информация</h2>
                    <span class="sf-hint">Полетата с * са препоръчителни</span>
                </div>

                <div class="sf-grid sf-grid--2">
                    <div class="sf-field">
                        <label asp-for="Name">Име *</label>
                        <input asp-for="Name" placeholder="Напр. Eco Market" />
                        <span asp-validation-for="Name" class="sf-error"></span>
                    </div>

                    <div class="sf-field">
                        <label asp-for="Category">Категория</label>
                        <select asp-for="Category">
                            <option value="">-- избери --</option>
                            @foreach (var c in categories)
                            {
                                <option value="@c">@c</option>
                            }
                        </select>
                        <span asp-validation-for="Category" class="sf-error"></span>
                    </div>

                    <div class="sf-field sf-span-2">
                        <label asp-for="ShortDescription">Кратко описание</label>
                        <input asp-for="ShortDescription" maxlength="200" placeholder="1 изречение, което продава идеята (до 200 символа)" />
                        <div class="sf-help">Ще се показва в картите и началната страница.</div>
                        <span asp-validation-for="ShortDescription" class="sf-error"></span>
                    </div>

                    <div class="sf-field sf-span-2">
                        <label asp-for="Description">Описание</label>
                        <textarea asp-for="Description" placeholder="Разкажи за магазина, мисията, продуктите..."></textarea>
                        <span asp-validation-for="Description" class="sf-error"></span>
                    </div>
                </div>
            </section>

            <!-- SECTION: Локация -->
            <section class="sf-card">
                <div class="sf-card__head">
                    <h2>Локация</h2>
                    <span class="sf-hint">Адресът и координатите помагат за картата</span>
                </div>

                <div class="sf-grid sf-grid--2">
                    <div class="sf-field sf-span-2">
                        <label asp-for="Address">Адрес</label>
                        <input asp-for="Address" placeholder="ул. ..., град ..." />
                        <span asp-validation-for="Address" class="sf-error"></span>
                    </div>

                    <div class="sf-field">
                        <label asp-for="Latitude">Latitude</label>
                        <input asp-for="Latitude" type="number" step="0.000001" placeholder="42.6977" />
                        <span asp-validation-for="Latitude" class="sf-error"></span>
                    </div>

                    <div class="sf-field">
                        <label asp-for="Longitude">Longitude</label>
                        <input asp-for="Longitude" type="number" step="0.000001" placeholder="23.3219" />
                        <span asp-validation-for="Longitude" class="sf-error"></span>
                    </div>
                </div>
            </section>

            <!-- SECTION: Работно време -->
            <section class="sf-card">
                <div class="sf-card__head">
                    <h2>Работно време</h2>
                    <span class="sf-hint">По избор</span>
                </div>

                <div class="sf-grid sf-grid--3">
                    <div class="sf-field">
                        <label asp-for="MonToFriHours">Пон–Пет</label>
                        <input asp-for="MonToFriHours" placeholder="09:00-18:00" />
                    </div>
                    <div class="sf-field">
                        <label asp-for="SatHours">Събота</label>
                        <input asp-for="SatHours" placeholder="10:00-14:00" />
                    </div>
                    <div class="sf-field">
                        <label asp-for="SunHours">Неделя</label>
                        <input asp-for="SunHours" placeholder="затворено" />
                    </div>
                </div>
            </section>

            <!-- SECTION: Еко & услуги -->
            <section class="sf-card">
                <div class="sf-card__head">
                    <h2>Еко & услуги</h2>
                    <span class="sf-hint">Това се показва като badges в детайлите</span>
                </div>

                <div class="sf-grid sf-grid--2">
                    <div class="sf-field sf-span-2">
                        <label asp-for="EcoTags">Еко тагове</label>
                        <input asp-for="EcoTags" placeholder="Zero-waste, Bio, Local, Vegan" />
                        <div class="sf-help">Раздели със запетая. Пример: <em>Zero-waste, Bio, Local</em></div>
                    </div>

                    <div class="sf-field sf-span-2">
                        <label asp-for="Certifications">Сертификати</label>
                        <input asp-for="Certifications" placeholder="FSC, EU Organic" />
                    </div>
                </div>

                <div class="sf-toggles">
                    <label class="sf-toggle">
                        <input asp-for="AcceptsOwnPackaging" />
                        <span class="sf-toggle__ui"></span>
                        <span class="sf-toggle__text">Приема собствени опаковки</span>
                    </label>

                    <label class="sf-toggle">
                        <input asp-for="IsProducer" />
                        <span class="sf-toggle__ui"></span>
                        <span class="sf-toggle__text">Производител</span>
                    </label>

                    <label class="sf-toggle">
                        <input asp-for="HasRefillStation" />
                        <span class="sf-toggle__ui"></span>
                        <span class="sf-toggle__text">Refill / наливни продукти</span>
                    </label>

                    <label class="sf-toggle">
                        <input asp-for="HasDelivery" />
                        <span class="sf-toggle__ui"></span>
                        <span class="sf-toggle__text">Доставка</span>
                    </label>
                </div>
            </section>

            <!-- SECTION: Контакти -->
            <section class="sf-card">
                <div class="sf-card__head">
                    <h2>Контакти</h2>
                    <span class="sf-hint">По избор</span>
                </div>

                <div class="sf-grid sf-grid--2">
                    <div class="sf-field">
                        <label asp-for="Website">Уебсайт</label>
                        <input asp-for="Website" placeholder="https://..." />
                        <span asp-validation-for="Website" class="sf-error"></span>
                    </div>

                    <div class="sf-field">
                        <label asp-for="Email">Имейл</label>
                        <input asp-for="Email" type="email" placeholder="store@email.com" />
                        <span asp-validation-for="Email" class="sf-error"></span>
                    </div>

                    <div class="sf-field">
                        <label asp-for="InstagramUrl">Instagram</label>
                        <input asp-for="InstagramUrl" placeholder="https://instagram.com/..." />
                        <span asp-validation-for="InstagramUrl" class="sf-error"></span>
                    </div>

                    <div class="sf-field">
                        <label asp-for="FacebookUrl">Facebook</label>
                        <input asp-for="FacebookUrl" placeholder="https://facebook.com/..." />
                        <span asp-validation-for="FacebookUrl" class="sf-error"></span>
                    </div>
                </div>

                <!-- Телефони (оставям ти го базово, защото при теб е List<string> Phones) -->
                <div class="sf-field sf-mt">
                    <label>Телефони</label>
                    <div id="phonesList" class="sf-repeater">
                        <div class="sf-repeater__row">
                            <input name="Phones" placeholder="+359 88 123 4567" />
                            <button type="button" class="sf-iconbtn sf-remove" style="display:none;" title="Премахни">✕</button>
                        </div>
                    </div>
                    <button type="button" id="addPhoneBtn" class="sf-secondary">+ Добави още телефон</button>
                </div>
            </section>

            <!-- SECTION: Снимки -->
            <section class="sf-card">
                <div class="sf-card__head">
                    <h2>Снимки</h2>
                    <span class="sf-hint">Първата ще е cover</span>
                </div>

                <div class="sf-upload">
                    <input id="photosInput" name="Photos" type="file" multiple accept="image/*" />
                    <div class="sf-upload__note">Можеш да избереш няколко снимки. После можеш да махнеш някоя преди “Запази”.</div>
                </div>

                <div id="photoPreviews" class="sf-previews"></div>
            </section>

            <div class="sf-actions">
                <button type="submit" class="sf-primary">Запази магазина</button>
                <button type="button" class="sf-link" onclick="history.back()">
                    ← Назад
                </button>

            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script>
        (function () {
            // Phones repeater
            const phonesList = document.getElementById('phonesList');
            const addPhoneBtn = document.getElementById('addPhoneBtn');

            function refreshRemoveButtons() {
                const rows = phonesList.querySelectorAll('.sf-repeater__row');
                rows.forEach((row, idx) => {
                    const btn = row.querySelector('.sf-remove');
                    if (!btn) return;
                    btn.style.display = rows.length > 1 ? 'inline-flex' : 'none';
                });
            }

            function addPhone(value) {
                const row = document.createElement('div');
                row.className = 'sf-repeater__row';
                row.innerHTML = `
                    <input name="Phones" placeholder="+359 88 123 4567" />
                    <button type="button" class="sf-iconbtn sf-remove" title="Премахни">✕</button>
                `;
                const input = row.querySelector('input');
                if (value) input.value = value;
                row.querySelector('.sf-remove').addEventListener('click', () => {
                    row.remove();
                    refreshRemoveButtons();
                });
                phonesList.appendChild(row);
                refreshRemoveButtons();
            }

            addPhoneBtn?.addEventListener('click', () => addPhone());
            // first row remove hidden unless >1
            const firstRemove = phonesList.querySelector('.sf-remove');
            firstRemove?.addEventListener('click', (e) => {
                e.preventDefault();
                // shouldn't happen when hidden, but just in case:
                if (phonesList.querySelectorAll('.sf-repeater__row').length > 1) {
                    firstRemove.closest('.sf-repeater__row').remove();
                    refreshRemoveButtons();
                }
            });
            refreshRemoveButtons();

            // Photos preview + remove before submit (DataTransfer)
            const fileInput = document.getElementById('photosInput');
            const previews = document.getElementById('photoPreviews');
            let dt = new DataTransfer();

            function renderPreviews() {
                previews.innerHTML = '';
                const files = Array.from(dt.files);

                if (files.length === 0) {
                    previews.innerHTML = `<div class="sf-empty">Няма избрани снимки.</div>`;
                    return;
                }

                files.forEach((file, index) => {
                    const url = URL.createObjectURL(file);

                    const card = document.createElement('div');
                    card.className = 'sf-preview';

                    const img = document.createElement('img');
                    img.src = url;
                    img.alt = file.name;

                    const meta = document.createElement('div');
                    meta.className = 'sf-preview__meta';
                    meta.innerHTML = `
                        <div class="sf-preview__name" title="${file.name}">${file.name}</div>
                        <div class="sf-preview__sub">${Math.round(file.size / 1024)} KB${index === 0 ? " • cover" : ""}</div>
                    `;

                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = 'sf-preview__remove';
                    btn.textContent = 'Премахни';
                    btn.addEventListener('click', () => {
                        // remove by rebuilding DataTransfer
                        const newDt = new DataTransfer();
                        files.forEach((f, i) => { if (i !== index) newDt.items.add(f); });
                        dt = newDt;
                        fileInput.files = dt.files;
                        renderPreviews();
                    });

                    card.appendChild(img);
                    card.appendChild(meta);
                    card.appendChild(btn);
                    previews.appendChild(card);
                });
            }

            fileInput?.addEventListener('change', () => {
                const incoming = Array.from(fileInput.files || []);
                incoming.forEach(f => dt.items.add(f));
                fileInput.files = dt.files;
                renderPreviews();
            });

            renderPreviews();
        })();
    </script>
}
